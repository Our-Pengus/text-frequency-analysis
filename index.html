<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í…ìŠ¤íŠ¸ ë¹ˆë„ ë¶„ì„ê¸°</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Noto Sans KR", sans-serif;
        background: #f7f8fa;
        min-height: 100vh;
        padding: 24px 16px;
        line-height: 1.5;
      }
      .container {
        max-width: 680px;
        margin: 0 auto;
      }
      h1 {
        color: #191f28;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 32px;
        letter-spacing: -0.5px;
      }
      .card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      }
      textarea {
        width: 100%;
        min-height: 180px;
        padding: 16px;
        border: 1px solid #e5e8eb;
        border-radius: 12px;
        font-size: 15px;
        font-family: inherit;
        resize: vertical;
        background: #fafbfc;
        color: #191f28;
        transition: all 0.2s;
      }
      textarea:focus {
        outline: none;
        border-color: #3182f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(49, 130, 246, 0.1);
      }
      textarea::placeholder {
        color: #8b95a1;
      }
      .controls {
        display: flex;
        gap: 8px;
        margin: 16px 0;
      }
      button {
        flex: 1;
        padding: 14px 20px;
        background: #3182f6;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(49, 130, 246, 0.2);
      }
      button:hover:not(:disabled) {
        background: #1b64da;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(49, 130, 246, 0.3);
      }
      button:active:not(:disabled) {
        transform: translateY(0);
      }
      button:disabled {
        background: #e5e8eb;
        color: #8b95a1;
        cursor: not-allowed;
        box-shadow: none;
      }
      button.secondary {
        background: white;
        color: #3182f6;
        border: 1px solid #e5e8eb;
        box-shadow: none;
      }
      button.secondary:hover:not(:disabled) {
        background: #f7f8fa;
        border-color: #3182f6;
      }
      .status {
        padding: 12px 16px;
        margin-bottom: 16px;
        border-radius: 12px;
        font-size: 14px;
        display: none;
        animation: slideDown 0.3s ease;
      }
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .status.info {
        background: #e8f4fd;
        color: #1b64da;
        display: block;
      }
      .status.error {
        background: #fee;
        color: #f04452;
        display: block;
      }
      .results {
        margin-top: 24px;
      }
      .results h2 {
        color: #191f28;
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: -0.3px;
      }
      .results-notice {
        color: #8b95a1;
        font-size: 13px;
        margin-bottom: 16px;
        margin-top: 0;
      }
      .result-item {
        display: flex;
        align-items: center;
        padding: 16px;
        margin-bottom: 8px;
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e8eb;
        transition: all 0.2s;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      .result-item:hover {
        border-color: #3182f6;
        box-shadow: 0 2px 8px rgba(49, 130, 246, 0.1);
        transform: translateX(4px);
      }
      .result-rank {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f7f8fa;
        border-radius: 10px;
        font-weight: 700;
        color: #8b95a1;
        font-size: 14px;
        margin-right: 16px;
      }
      .result-item:nth-child(1) .result-rank {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        color: white;
      }
      .result-item:nth-child(2) .result-rank {
        background: linear-gradient(135deg, #c0c0c0 0%, #a0a0a0 100%);
        color: white;
      }
      .result-item:nth-child(3) .result-rank {
        background: linear-gradient(135deg, #cd7f32 0%, #b8860b 100%);
        color: white;
      }
      .result-content {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .result-word {
        font-size: 16px;
        font-weight: 600;
        color: #191f28;
      }
      .result-count {
        font-size: 16px;
        font-weight: 700;
        color: #3182f6;
        background: #e8f4fd;
        padding: 6px 12px;
        border-radius: 8px;
      }
      .top-word-section {
        margin-bottom: 16px;
      }
      .top-word-section h2 {
        color: #191f28;
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 16px;
        letter-spacing: -0.3px;
      }
      #canvas-container {
        width: 100%;
        height: 400px;
        background: #1a1a2e;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        border: 2px solid rgba(49, 130, 246, 0.3);
        overflow: hidden;
        position: relative;
      }
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: rgba(255, 255, 255, 0.8);
        font-size: 18px;
        z-index: 50;
        font-weight: 400;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“Š í…ìŠ¤íŠ¸ ë¹ˆë„ ë¶„ì„</h1>

      <div class="card">
        <textarea
          id="textInput"
          placeholder="ë¶„ì„í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”..."
        ></textarea>

        <div style="margin-bottom: 16px">
          <input
            type="file"
            id="fileInput"
            accept=".txt"
            style="display: none"
            onchange="handleFileUpload(event)"
          />
          <button
            class="secondary"
            onclick="document.getElementById('fileInput').click()"
            style="width: 100%"
          >
            í…ìŠ¤íŠ¸ íŒŒì¼ ì—…ë¡œë“œ
          </button>
        </div>

        <div class="controls">
          <button id="analyzeBtn" onclick="analyzeText()" disabled>
            ì „ì²´ ë¶„ì„
          </button>
          <button id="top10Btn" onclick="getTop10()" disabled>ìƒìœ„ 10ê°œ</button>
          <button class="secondary" onclick="clearResults()">ì´ˆê¸°í™”</button>
        </div>

        <div id="status" class="status"></div>
      </div>

      <div
        class="top-word-section card"
        id="topWordSection"
        style="display: none"
      >
        <h2>ğŸ† ê°€ì¥ ë§ì´ ë‚˜ì˜¨ ë‹¨ì–´</h2>
        <div id="canvas-container">
          <div id="loading">Loading font...</div>
        </div>
      </div>

      <div class="results card" id="resultsSection" style="display: none">
        <h2>ë¶„ì„ ê²°ê³¼</h2>
        <p class="results-notice">1MB ì´ìƒì˜ ëŒ€ìš©ëŸ‰ íŒŒì¼ì€ ìƒìœ„ 10ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤</p>
        <div id="resultsBody"></div>
      </div>
    </div>

    <script src="js/text_frequency_wasm.js"></script>
    <script src="js/text_frequency_js.js"></script>
    <script>
      let wasmModule = null;
      let uploadedFileText = null; // ì—…ë¡œë“œëœ íŒŒì¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ì €ì¥
      let uploadedFileSize = 0; // ì—…ë¡œë“œëœ íŒŒì¼ì˜ í¬ê¸° (ë°”ì´íŠ¸)

      // WASM ëª¨ë“ˆ ì´ˆê¸°í™”
      window.addEventListener("load", async () => {
        try {
          showStatus("WASM ëª¨ë“ˆ ë¡œë”© ì¤‘...", "info");
          wasmModule = await createModule({
            locateFile: (path, scriptDirectory) => scriptDirectory + path,
            onAbort: (what) => console.error("WASM ë¡œë“œ ì¤‘ë‹¨:", what),
          });
          showStatus("ì¤€ë¹„ ì™„ë£Œ!", "info");
          document.getElementById("analyzeBtn").disabled = false;
          document.getElementById("top10Btn").disabled = false;
        } catch (error) {
          showStatus("ì˜¤ë¥˜: " + error.message, "error");
        }
      });

      // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
      function showStatus(message, type) {
        const statusEl = document.getElementById("status");
        statusEl.textContent = message;
        statusEl.className = "status " + type;
      }

      // WASM ë²¡í„°ë¥¼ JS ë°°ì—´ë¡œ ë³€í™˜
      function vectorToArray(cppVector) {
        const results = [];
        for (let i = 0; i < cppVector.size(); i++) {
          const item = cppVector.get(i);
          results.push({ word: item.word, count: item.count });
        }
        cppVector.delete();
        return results;
      }

      // ì „ì²´ ë¶„ì„ (WASM vs JS ì„±ëŠ¥ ë¹„êµ)
      async function analyzeText() {
        // textareaì— ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì—…ë¡œë“œëœ íŒŒì¼ í…ìŠ¤íŠ¸ ì‚¬ìš©
        const textInputValue = document.getElementById("textInput").value.trim();
        const text = textInputValue || uploadedFileText;

        if (!text || !wasmModule) return;

        try {
          showStatus("ë¶„ì„ ì¤‘...", "info");

          const wasmStart = performance.now();
          const wasmResults = vectorToArray(
            wasmModule.getFrequencyAnalysis(text)
          );
          const wasmTime = (performance.now() - wasmStart).toFixed(2);

          const jsStart = performance.now();
          analyzeFrequencyJS(text);
          const jsTime = (performance.now() - jsStart).toFixed(2);

          // 1MB ì´ìƒì˜ íŒŒì¼ì´ ì—…ë¡œë“œëœ ê²½ìš°, ìµœëŒ€ 10ê°œë§Œ í‘œì‹œ
          const MB_1 = 1 * 1024 * 1024;
          const isLargeFile = uploadedFileText && uploadedFileSize > MB_1;
          const displayLimit = isLargeFile ? 10 : wasmResults.length;
          const resultsToDisplay = wasmResults.slice(0, displayLimit);

          displayResults(resultsToDisplay);

          const statusMessage = isLargeFile
            ? `ë¶„ì„ ì™„ë£Œ! ìƒìœ„ ${displayLimit}ê°œ í‘œì‹œ (ì „ì²´ ${wasmResults.length}ê°œ) (WASM: ${wasmTime}ms | JS: ${jsTime}ms)`
            : `ë¶„ì„ ì™„ë£Œ! ì´ ${wasmResults.length}ê°œ (WASM: ${wasmTime}ms | JS: ${jsTime}ms)`;

          showStatus(statusMessage, "info");
        } catch (error) {
          showStatus("ë¶„ì„ ì‹¤íŒ¨: " + error.message, "error");
        }
      }

      // ìƒìœ„ 10ê°œ ë‹¨ì–´ ë¶„ì„
      async function getTop10() {
        // textareaì— ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì—…ë¡œë“œëœ íŒŒì¼ í…ìŠ¤íŠ¸ ì‚¬ìš©
        const textInputValue = document.getElementById("textInput").value.trim();
        const text = textInputValue || uploadedFileText;

        if (!text || !wasmModule) return;

        try {
          showStatus("ë¶„ì„ ì¤‘...", "info");
          const results = vectorToArray(wasmModule.getFrequencyAnalysis(text));
          displayResults(results.slice(0, 10));
          showStatus("ìƒìœ„ 10ê°œ ë‹¨ì–´ ë¶„ì„ ì™„ë£Œ!", "info");
        } catch (error) {
          showStatus("ë¶„ì„ ì‹¤íŒ¨: " + error.message, "error");
        }
      }

      // ê²°ê³¼ ì¹´ë“œ í‘œì‹œ
      function displayResults(results) {
        const resultsBody = document.getElementById("resultsBody");
        const topWordSection = document.getElementById("topWordSection");

        resultsBody.innerHTML = results
          .map(
            (r, i) =>
              `<div class="result-item" style="animation-delay: ${i * 0.03}s">
                    <div class="result-rank">${i + 1}</div>
                    <div class="result-content">
                        <span class="result-word">${r.word}</span>
                        <span class="result-count">${r.count}íšŒ</span>
                    </div>
                </div>`
          )
          .join("");
        document.getElementById("resultsSection").style.display = "block";

        // 1ìˆœìœ„ ë‹¨ì–´ë¥¼ 3Dë¡œ í‘œì‹œ
        if (results.length > 0) {
          topWordSection.style.display = "block";
          if (window.createText) {
            window.createText(results[0].word);
          }
        }
      }

      // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.type !== "text/plain" && !file.name.endsWith(".txt")) {
          showStatus("txt íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.", "error");
          return;
        }

        // íŒŒì¼ í¬ê¸° ì €ì¥ (ë°”ì´íŠ¸)
        uploadedFileSize = file.size;

        showStatus("íŒŒì¼ ì½ëŠ” ì¤‘...", "info");
        const reader = new FileReader();

        reader.onload = (e) => {
          const text = e.target.result;
          const textInput = document.getElementById("textInput");

          // íŒŒì¼ í…ìŠ¤íŠ¸ë¥¼ ë³„ë„ ë³€ìˆ˜ì— ì €ì¥
          uploadedFileText = text;

          // textarea ë¹„ìš°ê¸° ë° disabled ì²˜ë¦¬
          textInput.value = "";
          textInput.disabled = true;
          textInput.placeholder = "íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ";

          const fileSizeMB = (uploadedFileSize / (1024 * 1024)).toFixed(2);
          showStatus(`íŒŒì¼ "${file.name}" ë¡œë“œ ì™„ë£Œ! (${fileSizeMB}MB)`, "info");
        };

        reader.onerror = () => {
          showStatus("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨", "error");
        };

        reader.readAsText(file, "UTF-8");
      }

      // ì´ˆê¸°í™”
      function clearResults() {
        const textInput = document.getElementById("textInput");

        // textarea ì´ˆê¸°í™” ë° í™œì„±í™”
        textInput.value = "";
        textInput.disabled = false;
        textInput.placeholder = "ë¶„ì„í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”...";

        // íŒŒì¼ ì…ë ¥ ë° ì €ì¥ëœ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        document.getElementById("fileInput").value = "";
        uploadedFileText = null;
        uploadedFileSize = 0;

        // ê²°ê³¼ í™”ë©´ ìˆ¨ê¸°ê¸°
        document.getElementById("resultsSection").style.display = "none";
        document.getElementById("topWordSection").style.display = "none";

        showStatus("ì´ˆê¸°í™” ì™„ë£Œ!", "info");
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";
      import { FontLoader } from "three/addons/loaders/FontLoader.js";
      import { TextGeometry } from "three/addons/geometries/TextGeometry.js";

      // Scene, Camera, Rendererë¥¼ ì´ˆê¸°í™”í•  ë³€ìˆ˜
      let scene, camera, renderer, controls, particlesMesh;
      let textMesh = null;
      let font = null;
      let isInitialized = false;

      // Three.js ì´ˆê¸°í™” í•¨ìˆ˜
      function initThreeJS() {
        if (isInitialized) return;

        const container = document.getElementById("canvas-container");
        if (!container) return;

        // Scene ì„¤ì •
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);

        // ì»¨í…Œì´ë„ˆ í¬ê¸° (ê³ ì •ê°’ ì‚¬ìš©)
        const containerWidth = 648; // max-width: 680pxì—ì„œ padding 32px ì œì™¸
        const containerHeight = 400;

        // Camera ì„¤ì •
        camera = new THREE.PerspectiveCamera(
          75,
          containerWidth / containerHeight,
          0.1,
          1000
        );
        camera.position.set(-2, -1.5, 5);

        // Renderer ì„¤ì •
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(containerWidth, containerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // ê¸°ì¡´ ìº”ë²„ìŠ¤ ì œê±° í›„ ì¶”ê°€
        const existingCanvas = container.querySelector("canvas");
        if (existingCanvas) {
          existingCanvas.remove();
        }
        container.appendChild(renderer.domElement);

        // OrbitControls ì„¤ì •
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // ì¡°ëª… ì„¤ì •
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight1.position.set(5, 5, 5);
        scene.add(directionalLight1);

        const directionalLight2 = new THREE.DirectionalLight(0x87ceeb, 0.4);
        directionalLight2.position.set(-12, -12, 5);
        scene.add(directionalLight2);

        const pointLight = new THREE.PointLight(0x00ffff, 1, 100);
        pointLight.position.set(0, 0, 10);
        scene.add(pointLight);

        // ë°°ê²½ íŒŒí‹°í´ ìƒì„±
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 1000;
        const posArray = new Float32Array(particlesCount * 3);

        for (let i = 0; i < particlesCount * 3; i++) {
          posArray[i] = (Math.random() - 0.5) * 20;
        }

        particlesGeometry.setAttribute(
          "position",
          new THREE.BufferAttribute(posArray, 3)
        );

        const particlesMaterial = new THREE.PointsMaterial({
          size: 0.02,
          color: 0xffffff,
          transparent: true,
          opacity: 0.6,
        });

        particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);

        isInitialized = true;
        animate();
      }

      // createText í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
      window.createText = function (inputText) {
        // Three.js ì´ˆê¸°í™”
        if (!isInitialized) {
          initThreeJS();
        }

        if (!font) {
          console.log("Font not loaded yet");
          return;
        }

        if (!scene) {
          console.error("Scene not initialized");
          return;
        }

        console.log("Creating text:", inputText);

        if (textMesh) {
          scene.remove(textMesh);
          textMesh.geometry.dispose();
          if (Array.isArray(textMesh.material)) {
            textMesh.material.forEach((m) => m.dispose());
          } else {
            textMesh.material.dispose();
          }
        }

        const textGeometry = new TextGeometry(inputText, {
          font: font,
          size: 1.5,
          height: 0.3,
          curveSegments: 12,
          bevelEnabled: true,
          bevelThickness: 0.04,
          bevelSize: 0.03,
          bevelOffset: 0,
          bevelSegments: 5,
        });

        textGeometry.computeBoundingBox();
        const centerOffset =
          -0.5 *
          (textGeometry.boundingBox.max.x - textGeometry.boundingBox.min.x);

        const material = new THREE.MeshPhongMaterial({
          color: 0xffffff,
          specular: 0xcccccc,
          shininess: 100,
        });

        textMesh = new THREE.Mesh(textGeometry, material);
        textMesh.position.x = centerOffset;
        textMesh.position.y = 0;
        textMesh.position.z = 0;

        scene.add(textMesh);
        console.log("Text added to scene");
      };

      // í°íŠ¸ ë¡œë”©
      const loader = new FontLoader();
      loader.load(
        "./fonts/NanumMyeongjo_Regular.json",
        function (loadedFont) {
          font = loadedFont;
          document.getElementById("loading").style.display = "none";
        },
        function (xhr) {
          console.log((xhr.loaded / xhr.total) * 100 + "% loaded");
        },
        function (err) {
          console.error("An error happened loading the font:", err);
          document.getElementById("loading").textContent = "Error loading font";
        }
      );

      // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
      function animate() {
        if (!isInitialized) return;

        requestAnimationFrame(animate);

        if (textMesh) {
          textMesh.position.y = Math.sin(Date.now() * 0.001) * 0.15;
        }

        if (particlesMesh) {
          particlesMesh.rotation.y += 0.0005;
        }

        if (controls) {
          controls.update();
        }

        if (renderer && scene && camera) {
          renderer.render(scene, camera);
        }
      }
    </script>
  </body>
</html>
